<div class="product-list">
  <!-- Category Filter Section -->
  <div *ngIf="!filterCategory" style="background: white; padding: 1.5rem; margin-bottom: 2rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; display: flex; align-items: center;">
      🎯 Browse all products or select a specific lottery category:
    </h3>
    
    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
      <!-- All Products Button -->
      <button 
        (click)="clearCategoryFilter()"
        [ngStyle]="{
          'padding': '0.5rem 1rem',
          'border-radius': '0.5rem',
          'border': selectedCategoryFilter === 'all' ? '2px solid #3b82f6' : '1px solid #d1d5db',
          'background-color': selectedCategoryFilter === 'all' ? '#eff6ff' : '#f9fafb',
          'color': selectedCategoryFilter === 'all' ? '#1d4ed8' : '#6b7280',
          'font-weight': selectedCategoryFilter === 'all' ? '600' : '500',
          'cursor': 'pointer',
          'transition': 'all 0.2s ease',
          'font-size': '0.875rem'
        }"
        [attr.aria-pressed]="selectedCategoryFilter === 'all'">
        🛍️ All Products
      </button>

      <!-- Dynamic Category Buttons -->
      <button 
        *ngFor="let category of categories"
        (click)="setCategoryFilter(category.name)"
        [ngStyle]="{
          'padding': '0.5rem 1rem',
          'border-radius': '0.5rem',
          'border': selectedCategoryFilter === category.name ? '2px solid ' + category.color : '1px solid #d1d5db',
          'background-color': selectedCategoryFilter === category.name ? category.color + '20' : '#f9fafb',
          'color': selectedCategoryFilter === category.name ? category.color : '#6b7280',
          'font-weight': selectedCategoryFilter === category.name ? '600' : '500',
          'cursor': 'pointer',
          'transition': 'all 0.2s ease',
          'font-size': '0.875rem'
        }"
        [attr.aria-pressed]="selectedCategoryFilter === category.name">
        {{ category.icon }} {{ category.display_name }}
      </button>
    </div>

    <!-- Active Filter Display -->
    <div *ngIf="selectedCategoryFilter !== 'all'" style="margin-top: 1rem; padding: 0.75rem; background-color: #f0f9ff; border-radius: 0.5rem; border-left: 4px solid #0ea5e9;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <span style="font-size: 0.875rem; color: #0c4a6e;">
          📂 Showing {{ getCategoryDisplayName(selectedCategoryFilter) }} products
        </span>
        <button 
          (click)="clearCategoryFilter()"
          style="padding: 0.25rem 0.5rem; background-color: #0ea5e9; color: white; border: none; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
          Clear Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Debug info (hidden by default, enable with [showDebug]="true") -->
  <div *ngIf="showDebug" style="background: #f3f4f6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem;">
    <p>Loading: {{ loading }}</p>
    <p>Total products: {{ products.length }}</p>
    <p>Displayed products: {{ getDisplayProducts().length }}</p>
    <p>Filter category: {{ filterCategory || 'None' }}</p>
    <p>API Base URL: {{ getApiUrl() }}</p>
    <p>Authenticated: {{ isAuthenticated() }}</p>
    <p *ngIf="isAuthenticated()">Current User: {{ getCurrentUser()?.name }}</p>
    <p *ngIf="error" style="color: #dc2626;">Error: {{ error }}</p>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div *ngFor="let product of getDisplayProducts()" class="product-card bg-white rounded-lg shadow-lg" 
         style="overflow: hidden; transition: all 0.3s ease; border: 1px solid #e5e7eb;">
      
      <!-- Product Image Placeholder -->
      <div style="height: 12rem; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 4rem;">
          <ng-container [ngSwitch]="getProductIcon(product.name)">
            <span *ngSwitchCase="'phone'">📱</span>
            <span *ngSwitchCase="'laptop'">💻</span>
            <span *ngSwitchCase="'console'">🎮</span>
            <span *ngSwitchCase="'watch'">⌚</span>
            <span *ngSwitchCase="'earbuds'">🎧</span>
            <span *ngSwitchCase="'tablet'">📱</span>
            <span *ngSwitchCase="'monitor'">🖥️</span>
            <span *ngSwitchDefault>📦</span>
          </ng-container>
        </span>
      </div>
      
      <!-- Product Info -->
      <div class="p-6">
        <!-- Dynamic Category Badge -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
          <span style="padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px;"
                [ngStyle]="{
                  'background-color': getCategoryColor(product.ticket_category) + '20',
                  'color': getCategoryColor(product.ticket_category),
                  'border': '1px solid ' + getCategoryColor(product.ticket_category) + '40'
                }">
            {{ getCategoryIcon(product.ticket_category) }} {{ getCategoryDisplayName(product.ticket_category) }}
          </span>
          <span style="color: #16a34a; font-size: 0.875rem; font-weight: 600;" *ngIf="product.in_stock">✅ In Stock</span>
        </div>
        
        <!-- Product Name -->
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; 
                   display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
          {{ product.name }}
        </h3>
        
        <!-- Description -->
        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem; 
                  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
          {{ product.description }}
        </p>
        
        <!-- Price and Lottery Info -->
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">{{ formatPrice(product.price) }}</span>
            <span style="font-size: 0.875rem; color: #6b7280;">IQD</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.875rem;">
            <span style="color: #6b7280;">🎟️ Lottery Tickets:</span>
            <span style="font-weight: 600; color: #2563eb;">{{ product.ticket_count }}</span>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button 
            class="btn-primary w-full"
            (click)="buyProduct(product)"
            [disabled]="!product.in_stock"
            aria-label="Buy {{ product.name }} for {{ formatPrice(product.price) }} IQD">
            <span *ngIf="product.in_stock">🛒 Buy Now</span>
            <span *ngIf="!product.in_stock">Out of Stock</span>
          </button>
          

        </div>
        
        <!-- Quick Info -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
          <div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.75rem; color: #6b7280;">
            <span>📦 Free Shipping</span>
            <span>🔒 Secure Payment</span>
            <span>🛡️ Warranty</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading State -->
  <div *ngIf="loading" style="text-align: center; padding: 3rem 0;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">⏳</div>
    <p style="color: #6b7280; font-size: 1.125rem;">Loading products...</p>
  </div>
  
  <!-- No Products State -->
  <div *ngIf="!loading && getDisplayProducts().length === 0" style="text-align: center; padding: 3rem 0;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">📦</div>
    <p style="color: #6b7280; font-size: 1.125rem;">
      <ng-container *ngIf="filterCategory; else noProductsGeneral">
        No {{ filterCategory }} category products available
      </ng-container>
      <ng-template #noProductsGeneral>No products available</ng-template>
    </p>
    <button 
      *ngIf="filterCategory"
      style="margin-top: 1rem; padding: 0.5rem 1rem; background-color: #3b82f6; color: white; border: none; border-radius: 0.5rem; cursor: pointer;"
      onclick="window.location.reload()">
      View All Products
    </button>
  </div>
</div>

<!-- Payment Form Modal -->
<app-payment-form 
  [product]="selectedProduct"
  [visible]="showPaymentForm"
  (visibleChange)="showPaymentForm = $event"
  (paymentSubmitted)="onPaymentSubmitted($event)">
</app-payment-form>
